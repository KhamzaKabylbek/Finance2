import SwiftUI
import UniformTypeIdentifiers

struct SettingsView: View {
    @Environment(\.presentationMode) var presentationMode
    @EnvironmentObject var store: TransactionStore
    @EnvironmentObject var authViewModel: AuthViewModel // –î–æ–±–∞–≤–ª—è–µ–º AuthViewModel

    @StateObject var goalStore: GoalStore
    @State private var selectedCurrency: Settings.Currency = .kzt
    @State private var showingAddGoal = false
    @State private var showingShareSheet = false
    @State private var showingLogoutAlert = false // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –∞–ª–µ—Ä—Ç–∞
    @State private var pushNotificationsEnabled = false

    @State private var csvString: String = ""
    @EnvironmentObject private var themeManager: ThemeManager
    
    init(goalStore: GoalStore) {
        _goalStore = StateObject(wrappedValue: goalStore)
    }
    
    private var incomeCategories: [Category] {
        store.categories.filter { $0.type == .income }
    }
    
    private func addGoal(_ goal: FinancialGoal) {
        goalStore.addGoal(goal)
    }
    
    var body: some View {
        NavigationView {
            List {
                // –í–∞–ª—é—Ç–∞
                Section("–í–∞–ª—é—Ç–∞") {
                    Picker("–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞–ª—é—Ç—É", selection: $selectedCurrency) {
                        ForEach(Settings.Currency.allCases, id: \.self) { currency in
                            HStack {
                                Text(currency.rawValue)
                                Text(currency.name)
                            }
                            .tag(currency)
                        }
                    }
                    .onChange(of: selectedCurrency) { oldValue, newValue in
                        store.updateCurrency(newValue)
                    }
                }

                Section("–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ") {
                    Toggle("–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ü–µ–ª—è—Ö", isOn: $pushNotificationsEnabled)
                }
                
                // –¢–µ–º–∞
                Section("–í–Ω–µ—à–Ω–∏–π –≤–∏–¥") {
                    Toggle("–¢–µ–º–Ω–∞—è —Ç–µ–º–∞", isOn: $themeManager.isDarkMode)
                }
                
                // –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ü–µ–ª–∏
                Section(header: Text("–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ü–µ–ª–∏"), footer: Text("–ù–∞–∂–º–∏—Ç–µ +, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —Ü–µ–ª—å")) {
                    ForEach(store.settings.financialGoals) { goal in
                        GoalRow(goal: goal)
                    }
                    Button(action: { showingAddGoal = true }) {
                        Label("–î–æ–±–∞–≤–∏—Ç—å —Ü–µ–ª—å", systemImage: "plus")
                    }
                }
                
                // –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
                Section("–≠–∫—Å–ø–æ—Ä—Ç") {
                    Button(action: prepareAndShareCSV) {
                        Label("–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –¥–∞–Ω–Ω—ã–º–∏", systemImage: "square.and.arrow.up")
                    }
                }
                //
                
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é —Å–µ–∫—Ü–∏—é –¥–ª—è –≤—ã—Ö–æ–¥–∞
                Section {
                    Button(action: { showingLogoutAlert = true }) {
                        HStack {
                            Text("–í—ã–π—Ç–∏")
                                .foregroundColor(.red)
                            Spacer()
                            Image(systemName: "rectangle.portrait.and.arrow.right")
                                .foregroundColor(.red)
                        }
                    }
                }
                
                Section("–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è") {
                    Toggle("–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ —Ü–µ–ª–µ–π", isOn: $pushNotificationsEnabled)
                        .onChange(of: pushNotificationsEnabled) { isEnabled in
                            if isEnabled {
                                GoalNotificationManager.shared.requestPermission()
                            } else {
                                UNUserNotificationCenter.current().removeAllPendingNotificationRequests()
                            }
                        }
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
                Section {
                    Button("Test Notification") {
                        let testGoal = FinancialGoal(name: "Test Goal", targetAmount: 1000, currentAmount: 1000, deadline: Date())
                        GoalNotificationManager.shared.notifyGoalAchieved(for: testGoal)
                    }
                }
            }
            .navigationTitle("–ù–∞—Å—Ç—Ä–æ–π–∫–∏")
            .navigationBarTitleDisplayMode(.inline)
            .navigationBarItems(
                leading: Button(action: { presentationMode.wrappedValue.dismiss() }) {
                    Image(systemName: "xmark")
                        .foregroundColor(.primary)
                }
            )
            .sheet(isPresented: $showingAddGoal) {
                AddGoalView()
            }
            .sheet(isPresented: $showingShareSheet) {
                ShareSheet(items: [generateCSV()])
            }
            .alert("–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞", isPresented: $showingLogoutAlert) {
                Button("–û—Ç–º–µ–Ω–∞", role: .cancel) { }
                Button("–í—ã–π—Ç–∏", role: .destructive) {
                    authViewModel.logout()
                    presentationMode.wrappedValue.dismiss()
                }
            } message: {
                Text("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?")
            }
        }
        .preferredColorScheme(themeManager.isDarkMode ? .dark : .light)
        .onAppear {
            selectedCurrency = store.settings.currency
        }
    }
            

    
    //
    
    private func prepareAndShareCSV() {
        showingShareSheet = true
    }
    
    private func generateCSV() -> URL {
        var csvString = "–î–∞—Ç–∞,–ö–∞—Ç–µ–≥–æ—Ä–∏—è,–¢–∏–ø,–°—É–º–º–∞,–ó–∞–º–µ—Ç–∫–∞\n"
        
        for transaction in store.transactions {
            let row = "\(formatDate(transaction.date)),\(transaction.category.name),\(transaction.type),\(transaction.amount),\(transaction.note)\n"
            csvString.append(row)
        }
        
        let fileURL = FileManager.default.temporaryDirectory.appendingPathComponent("transactions.csv")
        try? csvString.write(to: fileURL, atomically: true, encoding: .utf8)
        return fileURL
    }
    
    private func formatDate(_ date: Date) -> String {
        let formatter = DateFormatter()
        formatter.dateStyle = .short
        return formatter.string(from: date)
    }
}

struct GoalRow: View {
    @EnvironmentObject var store: TransactionStore
    let goal: FinancialGoal
    @State private var showingEditSheet = false
    @State private var showingDeleteAlert = false
    @State private var showingAddFundsSheet = false
    @State private var amountToAdd = ""
    @State private var pushNotificationsEnabled = false
    
    var body: some View {
        VStack(alignment: .leading, spacing: 8) {
            HStack {
                VStack(alignment: .leading) {
                    Text(goal.name)
                        .font(.headline)
                    Text("–°—Ä–æ–∫: \(formatDate(goal.deadline))")
                        .font(.caption)
                        .foregroundColor(.gray)
                }
                Spacer()
                Menu {
                    Button(action: { showingAddFundsSheet = true }) {
                        Label("–ü–æ–ø–æ–ª–Ω–∏—Ç—å", systemImage: "plus.circle")
                    }
                    Button(action: { showingEditSheet = true }) {
                        Label("–ò–∑–º–µ–Ω–∏—Ç—å", systemImage: "pencil")
                    }
                    Button(role: .destructive, action: { showingDeleteAlert = true }) {
                        Label("–£–¥–∞–ª–∏—Ç—å", systemImage: "trash")
                    }
                } label: {
                    Image(systemName: "ellipsis")
                        .foregroundColor(.gray)
                }
            }
            
            HStack {
                Text("\(Int(goal.progress * 100))%")
                    .font(.caption)
                Spacer()
                Text("\(store.formatAmount(goal.currentAmount)) / \(store.formatAmount(goal.targetAmount))")
                    .font(.caption)
            }
            
            GeometryReader { geometry in
                ZStack(alignment: .leading) {
                    Rectangle()
                        .fill(Color.gray.opacity(0.3))
                        .frame(height: 8)
                        .cornerRadius(4)
                    
                    Rectangle()
                        .fill(goal.progress >= 1 ? Color.green : Color.blue)
                        .frame(width: min(CGFloat(goal.progress) * geometry.size.width, geometry.size.width), height: 8)
                        .cornerRadius(4)
                }
            }
            .frame(height: 8)
            
            if goal.progress >= 1 {
                Text("–¶–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞! üéâ")
                    .font(.caption)
                    .foregroundColor(.green)
                    .onAppear {
                        if pushNotificationsEnabled {
                            GoalNotificationManager.shared.notifyGoalAchieved(for: goal)
                        }
                    }
            }
        }
        .sheet(isPresented: $showingEditSheet) {
            EditGoalView(goal: goal)
        }
        .sheet(isPresented: $showingAddFundsSheet) {
            NavigationView {
                Form {
                    Section(header: Text("–î–æ–±–∞–≤–∏—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞")) {
                        TextField("–°—É–º–º–∞", text: $amountToAdd)
                            .keyboardType(.decimalPad)
                    }
                    
                    Section(footer: Text("–°—Ä–µ–¥—Å—Ç–≤–∞ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –∫ —Ç–µ–∫—É—â–µ–º—É –ø—Ä–æ–≥—Ä–µ—Å—Å—É —Ü–µ–ª–∏")) {
                        Button(action: addFunds) {
                            Text("–ü–æ–ø–æ–ª–Ω–∏—Ç—å")
                                .frame(maxWidth: .infinity)
                                .foregroundColor(.blue)
                        }
                    }
                }
                .navigationTitle("–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —Ü–µ–ª–∏")
                .navigationBarItems(
                    trailing: Button("–ì–æ—Ç–æ–≤–æ") {
                        showingAddFundsSheet = false
                    }
                )
            }
        }
        .alert("–£–¥–∞–ª–∏—Ç—å —Ü–µ–ª—å?", isPresented: $showingDeleteAlert) {
            Button("–û—Ç–º–µ–Ω–∞", role: .cancel) { }
            Button("–£–¥–∞–ª–∏—Ç—å", role: .destructive) {
                store.deleteGoal(goal)
            }
        }
    }
    
    private func addFunds() {
        if let amount = Double(amountToAdd), amount > 0 {
            store.addFundsToGoal(goal, amount: amount)
            amountToAdd = ""
            showingAddFundsSheet = false
        }
    }
    
    private func formatDate(_ date: Date) -> String {
        let formatter = DateFormatter()
        formatter.dateStyle = .medium
        return formatter.string(from: date)
    }
}

struct EditGoalView: View {
    @Environment(\.dismiss) var dismiss
    @EnvironmentObject var store: TransactionStore
    let goal: FinancialGoal
    
    @State private var name: String
    @State private var targetAmount: String
    @State private var currentAmount: String
    @State private var deadline: Date
    @State private var selectedCategory: Category?
    
    var incomeCategories: [Category] {
        store.categories.filter { $0.type == .income }
    }
    
    init(goal: FinancialGoal) {
        self.goal = goal
        _name = State(initialValue: goal.name)
        _targetAmount = State(initialValue: String(goal.targetAmount))
        _currentAmount = State(initialValue: String(goal.currentAmount))
        _deadline = State(initialValue: goal.deadline)
        _selectedCategory = State(initialValue: goal.category)
    }
    
    var body: some View {
        NavigationView {
            Form {
                TextField("–ù–∞–∑–≤–∞–Ω–∏–µ —Ü–µ–ª–∏", text: $name)
                TextField("–¶–µ–ª–µ–≤–∞—è —Å—É–º–º–∞", text: $targetAmount)
                    .keyboardType(.decimalPad)
                TextField("–¢–µ–∫—É—â–∞—è —Å—É–º–º–∞", text: $currentAmount)
                    .keyboardType(.decimalPad)
                DatePicker("–°—Ä–æ–∫", selection: $deadline, displayedComponents: .date)
                
                Picker("–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–æ—Ö–æ–¥–∞", selection: $selectedCategory) {
                    Text("–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏").tag(nil as Category?)
                    ForEach(incomeCategories) { category in
                        Text(category.name).tag(category as Category?)
                    }
                }
            }
            .navigationTitle("–ò–∑–º–µ–Ω–∏—Ç—å —Ü–µ–ª—å")
            .navigationBarItems(
                leading: Button("–û—Ç–º–µ–Ω–∞") { dismiss() },
                trailing: Button("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å") {
                    if let targetAmount = Double(targetAmount),
                       let currentAmount = Double(currentAmount),
                       !name.isEmpty {
                        let updatedGoal = FinancialGoal(
                            id: goal.id,
                            name: name,
                            targetAmount: targetAmount,
                            currentAmount: currentAmount,
                            deadline: deadline,
                            category: selectedCategory
                        )
                        store.updateGoal(updatedGoal)
                        dismiss()
                    }
                }
            )
        }
    }
}

struct AddGoalView: View {
    @Environment(\.dismiss) var dismiss
    @EnvironmentObject var store: TransactionStore
    
    @State private var name = ""
    @State private var targetAmount = ""
    @State private var deadline = Date()
    @State private var selectedCategory: Category?
    @State private var autoSavePercentage = 10.0
    @State private var milestoneNotifications = true
    
    private var incomeCategories: [Category] {
        store.categories.filter { $0.type == .income }
    }
    
    var body: some View {
        NavigationView {
            Form {
                Section(header: Text("–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è")) {
                    TextField("–ù–∞–∑–≤–∞–Ω–∏–µ —Ü–µ–ª–∏", text: $name)
                    TextField("–¶–µ–ª–µ–≤–∞—è —Å—É–º–º–∞", text: $targetAmount)
                        .keyboardType(.decimalPad)
                    DatePicker("–°—Ä–æ–∫", selection: $deadline, displayedComponents: .date)
                }
                
                Section(header: Text("–ò—Å—Ç–æ—á–Ω–∏–∫ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è")) {
                    Picker("–ö–∞—Ç–µ–≥–æ—Ä–∏—è –¥–æ—Ö–æ–¥–∞", selection: $selectedCategory) {
                        Text("–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏").tag(nil as Category?)
                        ForEach(incomeCategories) { category in
                            Text(category.name).tag(category as Category?)
                        }
                    }
                    
                    if selectedCategory != nil {
                        VStack(alignment: .leading) {
                            Text("–û—Ç–∫–ª–∞–¥—ã–≤–∞—Ç—å –æ—Ç –¥–æ—Ö–æ–¥–∞: \(Int(autoSavePercentage))%")
                            Slider(value: $autoSavePercentage, in: 1...100, step: 1)
                        }
                    }
                }
                
                Section(header: Text("–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è")) {
                    Toggle("–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è—Ö", isOn: $milestoneNotifications)
                }
            }
            .navigationTitle("–ù–æ–≤–∞—è —Ü–µ–ª—å")
            .navigationBarItems(
                leading: Button("–û—Ç–º–µ–Ω–∞") { dismiss() },
                trailing: Button("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å") {
                    if let amount = Double(targetAmount), !name.isEmpty {
                        let goal = FinancialGoal(
                            name: name,
                            targetAmount: amount,
                            deadline: deadline,
                            category: selectedCategory,
                            autoSavePercentage: autoSavePercentage,
                            milestoneNotifications: milestoneNotifications
                        )
                        store.addGoal(goal)
                        
                        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                        if milestoneNotifications {
                            NotificationManager.shared.scheduleDeadlineReminder(for: goal)
                            NotificationManager.shared.scheduleWeeklyProgressNotification(for: goal)
                        }
                        
                        dismiss()
                    }
                }
            )
        }
    }
}

struct ShareSheet: UIViewControllerRepresentable {
    let items: [Any]
    
    func makeUIViewController(context: Context) -> UIActivityViewController {
        UIActivityViewController(activityItems: items, applicationActivities: nil)
    }
    
    func updateUIViewController(_ uiViewController: UIActivityViewController, context: Context) {}
}
